# 📝 Daily News English - 記事自動保存機能の実装報告

## 🎯 実装概要

英語学習アプリ「Daily News English」に、生成した記事レッスンを自動的にNotionデータベースに保存する機能を実装しました。これにより、ユーザーは過去に生成した記事を振り返り、再度学習することができるようになりました。

---

## ✅ 実装した機能

### 1. 記事の自動保存機能
- 記事レッスンを生成した際、自動的にNotionデータベースに保存
- 重複チェック機能：過去24時間以内に同じタイトルの記事が存在する場合は、新しいページを作成せずに既存のページIDを返す
- エラーが発生しても記事生成処理は継続（保存失敗は警告のみ）

### 2. 過去の記事一覧表示機能
- `/lessons`ページで過去に生成した記事を一覧表示
- 記事をクリックして再度トレーニングを開始可能
- ユーザーごとにフィルタリング（自分の記事のみ表示）

### 3. ナビゲーション改善
- ヘッダーに「過去の記事」リンクを追加
- ダッシュボードに「過去の記事」カードを追加

---

## 🛠 技術的な実装詳細

### バックエンド実装

#### 1. NotionServiceの拡張
**ファイル**: `backend/app/services/notion_service.py`

**追加したメソッド：**
- `save_lesson()`: 記事レッスンをNotionに保存
- `get_user_lessons()`: ユーザーの過去の記事を取得

**重複チェックロジック：**
- 同じタイトル + 同じユーザー + 過去24時間以内の記事を検索
- 見つかった場合は新しいページを作成せず、既存のページIDを返す

#### 2. APIエンドポイントの追加
**ファイル**: `backend/app/routes/lesson.py`

**追加したエンドポイント：**
- `GET /api/lesson/history`: ユーザーの過去の記事を取得

**既存エンドポイントの変更：**
- `POST /api/lesson/generate`: 記事生成後に自動保存
- `GET /api/lesson/generate/auto`: 記事生成後に自動保存

### フロントエンド実装

#### 1. 新しいページの作成
**ファイル**: `frontend/app/lessons/page.tsx`
- 過去の記事一覧を表示
- 記事をクリックしてトレーニングを開始

#### 2. APIクライアントの拡張
**ファイル**: `frontend/lib/api.ts`
- `getLessonHistory()`メソッドを追加

#### 3. UI改善
- ヘッダーに「過去の記事」リンクを追加
- ダッシュボードに「過去の記事」カードを追加

---

## 📊 Notionデータベースの構造

### 必要なデータベース

**データベース名**: 「Lessons」または任意の名前

### プロパティ（カラム）設定

| プロパティ名 | タイプ | 必須 | 説明 |
|------------|--------|------|------|
| `Title` | **Title** | ✅ | 記事タイトル（自動的に作成） |
| `Date` | **Date** | ✅ | 作成日時 |
| `UserEmail` | **Rich Text** | ✅ | ユーザーのメールアドレス |
| `Content` | **Rich Text** | ✅ | 記事内容（プレビュー用、最大2000文字） |
| `Category` | **Select** | ❌ | カテゴリ（例: News, Technology） |
| `Level` | **Select** | ❌ | レベル（例: B1, B2） |
| `JapaneseTitle` | **Rich Text** | ❌ | 元記事の日本語タイトル |

### データの保存形式

1. **プロパティ**: 基本的な情報（タイトル、日付、内容など）をプロパティとして保存
2. **ページ本文**: 完全なJSONデータをコードブロックとしてページ本文に保存（復元用）

---

## 🔧 環境変数の設定

### 必要な環境変数

```
NOTION_LESSONS_DB_ID=your_database_id_here
```

### データベースIDの取得方法

1. Notionでデータベースを開く
2. ブラウザのURLを確認
3. URLの最後の部分（`?v=`より前）がデータベースID

**例：**
```
URL: https://www.notion.so/workspace/abc123def456ghi789jkl012mno345pqr678stu901vwx234yz
データベースID: abc123def456ghi789jkl012mno345pqr678stu901vwx234yz
```

### 設定場所

- **ローカル開発**: `backend/.env`ファイル
- **本番環境（Railway）**: RailwayダッシュボードのVariablesタブ

---

## 📋 データフロー

### 記事生成時のフロー

```
1. ユーザーが記事を生成
   ↓
2. OpenAI APIでレッスンを生成
   ↓
3. 各レッスンをNotionに保存
   - 重複チェック（過去24時間以内）
   - 新しいページを作成
   - JSONデータをページ本文に保存
   ↓
4. レスポンスを返す
```

### 記事履歴取得時のフロー

```
1. ユーザーが「過去の記事」ページを開く
   ↓
2. API: GET /api/lesson/history
   ↓
3. Notionからユーザーの記事を取得
   - UserEmailでフィルタリング
   - 作成日時でソート（新しい順）
   ↓
4. ページ本文のJSONデータを復元
   ↓
5. フロントエンドで一覧表示
```

---

## 🎨 UI/UXの改善点

### 1. 記事ページとディスカッションページの相互遷移
- 記事ページから「Start Recording / Discussion」ボタンでディスカッションページへ
- ディスカッションページから「記事に戻る」「記事を振り返る」ボタンで記事ページへ
- 一度録音ページに行ったことがある場合、記事ページに「ディスカッションに戻る」ボタンを表示

### 2. 過去の記事一覧ページ
- カード形式で記事を表示
- タイトル、日付、カテゴリ、レベルを表示
- 記事をクリックして再度トレーニングを開始可能

---

## ⚠️ 注意事項

### 1. データベースIDについて
- **データベースID**は固定値（1つのデータベースに対して1つ）
- **ページID**は記事ごとに異なる（これは正常な動作）
- 環境変数に設定するのは**データベースID**のみ

### 2. 重複チェックについて
- 過去24時間以内に同じタイトルの記事が存在する場合、新しいページを作成しない
- これにより、同じ記事を複数回保存することを防ぐ
- 24時間を超えた場合は、新しいページとして保存される

### 3. エラーハンドリング
- Notionへの保存に失敗しても、記事生成処理は継続
- エラーはログに記録されるが、ユーザーには表示されない
- これにより、Notionが利用できない環境でも記事生成は可能

---

## 📈 今後の改善案

1. **検索機能**: 記事タイトルやカテゴリで検索
2. **フィルタリング**: カテゴリ、レベル、日付でフィルタ
3. **削除機能**: 不要な記事を削除
4. **編集機能**: 保存済み記事の編集
5. **エクスポート機能**: PDFやMarkdown形式でエクスポート

---

## 🔗 関連ファイル

### バックエンド
- `backend/app/services/notion_service.py` - Notion連携サービス
- `backend/app/routes/lesson.py` - レッスン関連API
- `backend/app/models/schemas.py` - データモデル

### フロントエンド
- `frontend/app/lessons/page.tsx` - 過去の記事一覧ページ
- `frontend/lib/api.ts` - APIクライアント
- `frontend/components/Header.tsx` - ヘッダーコンポーネント
- `frontend/app/dashboard/page.tsx` - ダッシュボード

---

## ✅ 動作確認方法

1. **記事を生成**
   - `/lesson`ページで記事を生成
   - Notionデータベースに保存されているか確認

2. **過去の記事を確認**
   - `/lessons`ページで過去の記事が表示されるか確認
   - 記事をクリックしてトレーニングを開始できるか確認

3. **重複チェック**
   - 同じタイトルの記事を24時間以内に再度生成
   - 新しいページが作成されないことを確認

---

**実装日**: 2026年1月25日  
**実装者**: AI Assistant (Composer)  
**ステータス**: ✅ 完了
